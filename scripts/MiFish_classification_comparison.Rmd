---
title: "MiFish_classification_compare"
author: "Erin D'Agnese"
date: "2023-03-14"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r loading libraries}
library(here)
library(rbiom)
library(tidyverse)
library(vegan)
library(janitor)
```

Bring in the ASV table 
```{r pull in biom and make ASV table and bring in metadata}
MiFishBiom <- read_biom(here("data","CorrectionBias","tourmaline-CorBias_MiFish_16072025","02-output-dada2-pe-unfiltered","00-table-repseqs", "table.biom"), tree = FALSE, prune = FALSE)

MiFishASV <- as.matrix(MiFishBiom$counts)
MiFishASV %>%
  as.data.frame() %>%
  tibble::rownames_to_column( ., "hash.id") -> MiFishASV

MiFishMD <- read_tsv(here("data","CorrectionBias","tourmaline-CorBias_MiFish_16072025","00-data", "metadata.tsv"))
```

Now bring in all the different classifications to compare
```{r}
local_MF_tax <- read_tsv(here("data","CorrectionBias","tourmaline-CorBias_MiFish_16072025","02-output-dada2-pe-unfiltered","01-taxonomyLocalZG","taxonomy.tsv"))

global_MF_tax <- read_tsv(here("data","CorrectionBias","tourmaline-CorBias_MiFish_16072025","02-output-dada2-pe-unfiltered","01-taxonomyUniversal","taxonomy.tsv"))
```

```{r}
local_MF_tax %>% 
  dplyr::rename("featureid"="Feature ID") -> local_MF_tax

global_MF_tax %>% 
  dplyr::rename("featureid"="Feature ID") -> global_MF_tax
```

bring in the decision function
```{r}
source(here("scripts","MiFish_Tax_compare_function.R"))
```


```{r}
mf_compare <- compare_taxonomy_tables(local_MF_tax,global_MF_tax)

mf_compare_summary <- summarize_rules(mf_compare)
mf_compare_summary
```



```{r tax comparison by hash}

mf_compare %>%
  select(featureid, final_taxonomy) -> MiFish_TaxAssign

write.table(MiFish_TaxAssign, here("intermediate-files","CorrectionBiasRun","MiFish","MiFish_final_Taxonomy.tsv"), quote=FALSE, sep='\t', col.names = TRUE, row.names = FALSE)

```

