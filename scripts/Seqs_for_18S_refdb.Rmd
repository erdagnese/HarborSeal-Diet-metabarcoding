---
title: "Seqs_for_18s_refDB"
author: "Erin D'Agnese"
date: "2025-07-16"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This script is to pull the sequences from the tissue mixtures thathave known input of species that are missing from the 18S reference db
1. Big skate - Raja binoculata
2. ratfish - Hydrolagus colliei
3. all the pandalid shrimp - Pandalus jordani (pink), Pandalus platyceros (spot prawn), Pandalus hypsinotus (coonstripe)
4. the lamprey - Lampetra ayresii
5. bay pipefish - Syngnathus leptorhynchus
6. stubby squid - Rossia pacifica
7. Longnose skate - Raja rhina
8. spiny dog-fish - Squalus acanthias
9. magister armhook squid - 
10 - Vaq black-tiger shrimp
11. bay shrimp
12. Ghost shrimp
13. red octopus
14. GPO

load the dataframes from the outputs of the 18S assignments
```{r}
library(here)

metadata18S <- read.table(here("data","CorrectionBias","tourmaline-CorBias_18S_16072025","00-data","metadata.tsv"), sep = "\t", header = T, check.names = F)

local_prey <- read.table(here("data","CorrectionBias","tourmaline-CorBias_18S_16072025","02-output-dada2-pe-unfiltered","01-taxonomy-local-prey", "asv_taxa_sample_table.tsv"), sep = "\t", header = T, check.names = F)

full_local <- read.table(here("data","CorrectionBias","tourmaline-CorBias_18S_16072025","02-output-dada2-pe-unfiltered","01-taxonomy-full-local", "asv_taxa_sample_table.tsv"), sep = "\t", header = T, check.names = F)

universal <- read.table(here("data","CorrectionBias","tourmaline-CorBias_18S_16072025","02-output-dada2-pe-unfiltered","01-taxonomy-universal", "asv_taxa_sample_table.tsv"), sep = "\t", header = T, check.names = F)

species_list <- read.csv(here("input-files", "Species_list_extracts.csv"), header = T, check.names = F)
metadata_run <- read.csv(here("input-files", "CorrectionBias_run_metadata.csv"), header = T, check.names = F)
```


```{r, include=FALSE}
library(tidyverse)

```

Now we need to pull out the samples in the metadata that we want to pull the sequences from
```{r}
species_list %>% 
  select(sp_abbrev, Species, Common_name) -> species_list

mixtures18S_samples <- metadata18S %>% 
  filter(region == "TissueMix") %>% 
  filter(str_detect(Plate_ID, "Prey18S"))

```

let's clean up the asv tables to make it easier to manage them
```{r}
# First, get the list of sample IDs from the metadata
sample_ids <- mixtures18S_samples$sampleid

# Select columns from universal dataframe
filtered_universal <- universal %>%
  # Keep the first 4 columns
  select(featureid, sequence, taxonomy, Confidence, 
         # And any columns that match sample IDs in metadata
         any_of(sample_ids))

# Check the result
head(filtered_universal)

```

```{r}
# Select columns from universal dataframe
filtered_full_local <- full_local %>%
  # Keep the first 4 columns
  select(featureid, sequence, taxonomy, Confidence, 
         # And any columns that match sample IDs in metadata
         any_of(sample_ids))

# Check the result
head(filtered_full_local)
```

```{r}
# Select columns from universal dataframe
filtered_local_prey <- local_prey %>%
  # Keep the first 4 columns
  select(featureid, sequence, taxonomy, Confidence, 
         # And any columns that match sample IDs in metadata
         any_of(sample_ids))

# Check the result
head(filtered_local_prey)
```

We need to make a map with the species names and abbreviation to be able to merge the sample data with the ASV data, but will need it in the future for tissue mixture analysis anyway, so let's make that and then save it into the input_files folder
```{r}
#first select only the mixtures from the metadata
metadata_run %>% 
  filter(region == "TissueMix") -> mixtures_all_md
```

Prepping the metadata
```{r}

mixtures_all_md %>% 
  left_join(.,species_list, by = "sp_abbrev") -> mixtures_all_md

```


cleaning up the asv tables to find sequences to pull that may actually be the input tissue
```{r}
filtered_asv_table <- filtered_full_local %>%
  # Keep identifier columns + target samples
  select(featureid, sequence, taxonomy, Confidence, 
         any_of(mixtures18S_md$sampleid)) %>%
  # Filter rows where ALL samples (excluding first 4 cols) have <10 reads
  filter(rowSums(select(., -c(featureid, sequence, taxonomy, Confidence)) >= 10) > 0)


# Create a named vector for renaming (sampleid -> samplename)
name_mapping <- setNames(mixtures18S_md$samplename, mixtures18S_md$sampleid)

# Rename columns in the ASV table
full_local_filt_asv_table <- filtered_asv_table %>%
  rename_with(~ ifelse(.x %in% names(name_mapping), name_mapping[.x], .x))
```

So I think now we need to make it a long-form table to be able to group and filter for the seqs we want to BLAST and then add to the reference DB
```{r}
## Step 1: Convert the ASV table from wide to long format
long_asv <- full_local_filt_asv_table %>%
  pivot_longer(
    cols = starts_with("TM_"), # Select all columns that start with "TM_"
    names_to = "samplename",
    values_to = "count"
  ) %>%
  filter(count > 0) # Optional: remove rows with zero counts

## Step 2: Join with metadata
combined_df <- long_asv %>%
  left_join(mixtures18S_md, by = "samplename")

## Optional: Reorder columns for better readability
combined_df <- combined_df %>%
  select(samplename, Species, Common_name, sequence, taxonomy, Confidence, count, featureid, sp_abbrev,
         sampleid, Plate_ID, Well_ID)

# View the result
head(combined_df)
```
Let's remove all the herring ASVs since we don't need that in the list of seqs to blast
```{r}
library(stringr)

# Define the taxonomic groups you want to remove (can be at any level)
taxa_to_remove <- c(
  "Ascomycota",       # Will match any taxonomy containing "Ascomycota"
  "Oomycota",         # Will match any oomycota
  "Mammalia",     # Will match mammal sequences
  "Clupeiformes"             # Will match all herring reads
)

# Filter using str_detect() with pattern collapse
filtered_combined <- combined_df %>%
  filter(!str_detect(taxonomy, paste(taxa_to_remove, collapse = "|")))
```

Group_by species and make dataframes for each species to be able to pull the sequences

```{r}
# Complete rebuild with absolute verification
species_wide_dfs_corrected <- map(unique(mixtures18S_md$sp_abbrev), ~ {
  sp <- .
  sp_samples <- mixtures18S_md %>% 
    filter(sp_abbrev == sp) %>% 
    pull(samplename)
  
  filtered_combined %>%
    filter(samplename %in% sp_samples) %>%
    select(featureid, sequence, taxonomy, Confidence, samplename, count) %>%
    pivot_wider(
      names_from = samplename,
      values_from = count,
      values_fill = 0
    ) %>%
    mutate(
      species_abbrev = sp,
      Species = first(mixtures18S_md$Species[mixtures18S_md$sp_abbrev == sp]),
      Common_name = first(mixtures18S_md$Common_name[mixtures18S_md$sp_abbrev == sp])
    ) %>%
    select(species_abbrev, Species, Common_name, everything())
}) %>% set_names(unique(mixtures18S_md$sp_abbrev))
```


