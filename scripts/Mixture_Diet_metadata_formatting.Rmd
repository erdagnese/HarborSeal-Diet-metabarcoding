---
title: "Mix_Diet_metadata_formatting"
author: "Erin D'Agnese"
date: "2025-08-27"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


This script is meant to take the input metadata for the diet and tissue mixtures and format them for use in all the correction scripts
```{r}
library(here)
library(tidyverse)
```

bring in files
```{r}
TM_md <- read.csv(here("input-files","TissueMixture_metadata.csv"),header = T,check.names = F)

CF_md <- read.csv(here("input-files","PvCF_master_diet_metadata.csv"),header = T,check.names = F)

CF_scat_md <- read.csv(here("input-files","PvCF_scat_metadata.csv"),header = T,check.names = F)

run_md <- read.csv(here("input-files","CorrectionBias_run_metadata.csv"),header = T,check.names = F)

sp_map <- read.csv(here("input-files","Species_mapping_18S_MiFish.csv"),header = T,check.names = F)


mock_md_18S <- read.csv(here("input-files","Mock_communities_18S_metadata.csv"),header = T,check.names = F)

mock_md_MF <- read.csv(here("input-files","Mock_communities_MiFish_metadata.csv"),header = T,check.names = F)

```

Let's deal with the controlled_feeding first, should be more straightforward
```{r}
CF_md %>% 
  mutate(actual_mass = as.numeric(actual_mass)) %>% 
  mutate(total_mass = as.numeric(total_mass)) %>% 
  mutate(expected_prop  = as.numeric(expected_prop)) %>% 
  mutate(actual_prop = actual_mass/total_mass) %>% 
  group_by(diet,date,seal_id) -> CF_md

CF_scat_md %>% 
  mutate(diet = paste("D",Diet,sep = "")) %>% 
  dplyr::select(!Diet) %>% 
  dplyr::rename("date"="Date") %>% 
  dplyr::select(!c(PCR_ID,Tech_rep)) %>% 
  distinct(SampleID,date,Time,diet,Seal_ID_1,Seal_ID_2,Scat_details) -> CF_scat_map


# First, pivot the CF_scat_map to long format for seal IDs
CF_scat_long <- CF_scat_map %>%
  mutate(across(c(Seal_ID_1, Seal_ID_2), ~na_if(., ""))) %>%
  pivot_longer(
    cols = c(Seal_ID_1, Seal_ID_2),
    names_to = "seal_source",
    values_to = "seal_id"
  ) %>%
  filter(!is.na(seal_id)) %>%
  dplyr::select(-seal_source) 

# Now join with CF_md to get the diet information
CF_combined_md <- CF_scat_long %>%
  left_join(CF_md, by = c("date", "seal_id", "diet")) %>%
  dplyr::select(SampleID, date, Time, seal_id, Scat_details, diet_sp, 
         expected_prop, actual_mass, total_mass, actual_prop) %>%
  arrange(SampleID, seal_id, diet_sp)

# View the result
head(CF_combined_md)
  
```
okay let's get the sp_map sorted and then joined for the CF metadata
```{r}
sp_map %>% 
  mutate(across(c(diet_sp, MiFish_taxon_assign), ~na_if(., ""))) %>%
  filter(!is.na(diet_sp)) %>% 
  dplyr::select(Species,MiFish_taxon_assign,"18S_taxon_assign",diet_sp) %>% 
  distinct()-> diet_sp_map

CF_combined_md <- left_join(CF_combined_md,diet_sp_map, by="diet_sp")

write.csv(CF_combined_md, here("input-files","PvCF_master_scat_metadata.csv"),row.names = F)
  
```

alright now the tissue mixtures
```{r}
TM_md %>% 
  dplyr::select(!c(Box_tiss_mix,Box_subs_mix,Mass_subs_mix_g,Overall_comments,Lost_mass,After_mix_mass,Subsampled_mix,Date,PacHer_sampleID)) %>% 
  mutate(prop_target = Target_initial_mass/Mixture_final_mass) %>% 
  mutate(prop_ref = PacHer_initial_mass/Mixture_final_mass) %>% 
  left_join(sp_map, by="Target_species") -> TM_md_temp

run_md %>% 
  filter(region == "TissueMix") %>% 
  mutate(sample = samplename) %>% 
  separate(samplename, into=c("TM","biol","SpeciesAbbrev","tech_rep"), sep = "_") %>% 
  unite(samplename, c("TM","biol","SpeciesAbbrev"), sep = "_") -> run_TM_md

TM_run_md <- left_join(run_TM_md, TM_md_temp,  by="samplename")

TM_run_md %>% 
  mutate(across(c(diet_sp, MiFish_taxon_assign), ~na_if(., ""))) %>% 
  mutate(tech_rep = as.numeric(tech_rep)) %>% 
  mutate(tech_rep = replace_na(tech_rep,1)) -> TM_run_md


write.csv(TM_run_md, here("input-files","TM_master_input_metadata.csv"), row.names = F)
```

we need to also make the model_name so it makes it easier to use in the model fit plotting and mapping to the model output 
```{r}
library(tidyverse)
library(stringr)

# Enhanced parser that handles complex station names
parse_sample_name <- function(samplename, region) {
  parts <- str_split(samplename, "_")[[1]]
  
  if (region == "ControlFeeding") {
    # Format: PvCF_D1_01_TR1 (exactly 4 parts)
    creek <- parts[1]
    station <- parts[2]
    biol <- as.integer(parts[3])
    tech <- as.integer(str_remove(parts[4], "TR"))
  } else if (region == "TissueMix") {
    creek <- "TM"
    biol <- as.integer(parts[2])
    
    # Check if last part is a tech rep (digits or R+digits)
    last_part <- tail(parts, 1)
    if (str_detect(last_part, "^(R?\\d+)$")) {
      tech <- as.integer(str_remove(last_part, "R"))
      # Station is everything between biol and tech
      station <- paste(parts[3:(length(parts)-1)], collapse = "_")
    } else {
      tech <- 1
      # Station is everything after biol
      station <- paste(parts[3:length(parts)], collapse = "_")
    }
  } else {
    return(list(creek = NA, station = NA, biol = NA, tech = NA))
  }
  
  return(list(creek = creek, station = station, biol = biol, tech = tech))
}

# Final transformation function
modified_sample_data <- function(asv_data) {
  asv_data %>%
    filter(region %in% c("ControlFeeding", "TissueMix")) %>%
    rowwise() %>%
    mutate(
      parsed = list(parse_sample_name(samplename, region)),
      creek = parsed$creek,
      station = parsed$station,
      biol = parsed$biol,
      tech = parsed$tech,
      time = 1,
       ) %>%
    ungroup() %>%
    # Keep samplename in the output for verification
    dplyr::select(samplename, time, creek, station, biol, tech) %>%
    filter(!is.na(creek))  # Remove any unparseable samples
}


# Run the transformation
#sample_data <- modified_sample_data(samples18S_asv_data)


```

We need to remake the model_name in this metadata for the input props 
```{r}
# don't need the mocks, that data is parsed in the amplification bias correction script
run_md %>% 
  filter(region != "MockCom") %>% 
  mutate(samplename_2 = samplename) -> run_obs_md

run_sample_data <- modified_sample_data(run_obs_md)

run_sample_data %>% 
  mutate(formatted_biol = ifelse(biol < 10, paste0("0", biol), as.character(biol))) %>% 
  mutate(SampleID = case_when(creek == "PvCF" ~ paste(creek,station,formatted_biol,sep = "_"),
                              creek == "TM"~ paste(creek,formatted_biol,station, sep = "_"))) -> run_sample_data

station_map_CF <- run_sample_data %>% 
  filter(creek == "PvCF") %>% 
  distinct(creek, station) %>% 
  arrange(creek, station) %>% 
  group_by(creek) %>% 
  mutate(station_num = row_number()) %>% 
  ungroup() %>% 
  mutate(station_idx = row_number())  

run_sample_data_cf <- left_join(run_sample_data, station_map_CF, by=c("creek","station"))  %>%
  filter(creek == "PvCF") %>%  distinct(samplename,time,creek,biol,tech,station,station_num,SampleID) 

run_sample_data_cf %>% 
  mutate(model_out_name = paste(time,creek,station_num,biol, sep = "_")) -> run_sample_data_cf

CF_combined_md_mod <- left_join(CF_combined_md,run_sample_data_cf, by="SampleID") 

write.csv(CF_combined_md_mod, here("input-files","PvCF_master_diet_sample_metadata.csv"), row.names = F)


  
```

NOW WE HAVE TO HANDLE THE STATION MAPPING FOR tm DIFFERENTLY SINCE THERE WILL BE DIFFERENT ONES FOR 18s AND MiFish
```{r}
TM_combined_md <- left_join(TM_run_md, run_sample_data, by = c("sample" ="samplename", "samplename"="SampleID"))

#Can't map stations to match due to the model input chucking out samples 
TM_combined_md %>% 
    mutate(station_alt = case_when(station == "BSkate" ~ "B_Skate",
                                 station == "LnoseSkate"~"Lnose_skate",
                                 station == "UnkVAQShr"~ "VAQShrimp",
                                 TRUE ~ station)) -> TM_combined_md

write.csv(TM_combined_md, here("input-files","TM_master_sample_metadata.csv"), row.names = F)
```

